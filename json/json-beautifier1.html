<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON格式化工具 - 免费在线JSON美化、压缩、校验、转换工具</title>
    <!-- SEO Meta标签 -->
    <meta name="description" content="专业的JSON格式化工具，支持JSON美化、压缩、校验、转CSV、转XML等功能，提供语法高亮、行号显示、深色模式，完全免费且本地化处理。">
    <meta name="keywords" content="JSON格式化,JSON美化,JSON压缩,JSON校验,JSON转CSV,JSON转XML,JSON工具,在线JSON,JSON格式化工具,免费JSON工具">
    <meta name="author" content="在线工具站">
    <meta name="robots" content="index, follow">
    <meta name="googlebot" content="index, follow">
    <meta name="rating" content="general">
    <meta name="revisit-after" content="7 days">
    
    <!-- Open Graph协议 -->
    <meta property="og:title" content="JSON格式化工具 - 免费在线JSON美化、压缩、校验、转换工具">
    <meta property="og:description" content="专业的JSON格式化工具，支持JSON美化、压缩、校验、转CSV、转XML等功能，提供语法高亮、行号显示、深色模式，完全免费且本地化处理。">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://webtool.example.com/json/json-beautifier.html">
    <meta property="og:image" content="https://webtool.example.com/images/json-tool-og.png">
    <meta property="og:site_name" content="在线工具站">
    <meta property="og:locale" content="zh_CN">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="JSON格式化工具 - 免费在线JSON美化、压缩、校验、转换工具">
    <meta name="twitter:description" content="专业的JSON格式化工具，支持JSON美化、压缩、校验、转CSV、转XML等功能，提供语法高亮、行号显示、深色模式，完全免费且本地化处理。">
    <meta name="twitter:image" content="https://webtool.example.com/images/json-tool-twitter.png">
    <meta name="twitter:site" content="@webtool">
    <meta name="twitter:creator" content="@webtool">
    
    <!-- 结构化数据 -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "JSON格式化工具",
      "applicationCategory": "DeveloperApplication",
      "operatingSystem": "Web",
      "url": "https://webtool.example.com/json/json-beautifier.html",
      "description": "专业的JSON格式化工具，支持JSON美化、压缩、校验、转CSV、转XML等功能，提供语法高亮、行号显示、深色模式，完全免费且本地化处理。",
      "keywords": "JSON格式化,JSON美化,JSON压缩,JSON校验,JSON转CSV,JSON转XML",
      "offers": {
        "@type": "Offer",
        "price": 0,
        "priceCurrency": "CNY"
      },
      "featureList": [
        "JSON格式化与美化",
        "JSON压缩与最小化",
        "JSON语法校验",
        "JSON转CSV转换",
        "CSV转JSON转换",
        "JSON转XML转换",
        "JSON Schema生成",
        "语法高亮显示",
        "行号显示",
        "深色模式支持",
        "本地数据处理",
        "历史记录保存"
      ],
      "screenshot": "https://webtool.example.com/images/json-tool-screenshot.png",
      "datePublished": "2024-01-01",
      "dateModified": "2024-01-01",
      "author": {
        "@type": "Organization",
        "name": "在线工具站团队",
        "url": "https://webtool.example.com/"
      }
    }
    </script>
    
    <!-- 规范链接 -->
    <link rel="canonical" href="https://webtool.example.com/json/json-beautifier.html">
    <link rel="home" href="https://webtool.example.com/">
    <link rel="index" href="https://webtool.example.com/">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 谷歌广告脚本 -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5542745258842294"
     crossorigin="anonymous"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#06b6d4',
                        light: '#f8fafc',
                        dark: '#1e293b'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .glass-effect {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            .transition-all-300 {
                transition: all 300ms ease-in-out;
            }
        }
    </style>
    <style>
        /* 自定义滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* 代码编辑器样式 */
        .json-editor {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.5;
            tab-size: 2;
        }
        
        /* 语法高亮 */
        .json-key {
            color: #2563eb;
        }
        .json-string {
            color: #16a34a;
        }
        .json-number {
            color: #b91c1c;
        }
        .json-boolean {
            color: #7c3aed;
        }
        .json-null {
            color: #64748b;
        }
        
        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* 脉冲动画 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <!-- 导航栏 -->
    <nav class="bg-white/80 backdrop-blur-sm border-b border-slate-200 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="../index.html" class="flex items-center space-x-2 text-primary font-semibold text-lg">
                        <i class="fa fa-tools text-xl"></i>
                        <span>在线工具站</span>
                    </a>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-slate-100 transition-all-300">
                        <i class="fa fa-moon-o text-slate-600"></i>
                    </button>
                    <a href="../index.html" class="text-slate-600 hover:text-primary transition-all-300">
                        <i class="fa fa-home"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- 页面标题 -->
        <div class="text-center mb-8 fade-in">
            <h1 class="text-4xl font-bold text-slate-800 mb-2 text-shadow">JSON格式化工具</h1>
            <p class="text-slate-600">快速格式化、压缩、校验和转换JSON数据</p>
        </div>

        <!-- 广告位 -->
        <div class="ad-container mb-8 max-w-2xl mx-auto">
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-5542745258842294"
                 data-ad-slot="2877002167"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
        </div>

        <!-- 工具卡片 -->
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden mb-8">
            <!-- 工具栏 -->
            <div class="bg-slate-50 border-b border-slate-200 p-4">
                <div class="flex flex-wrap gap-2 items-center justify-between">
                    <div class="flex flex-wrap gap-2">
                        <button id="format-btn" class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all-300 shadow-sm">
                            <i class="fa fa-indent"></i>
                            <span>格式化</span>
                        </button>
                        <button id="compress-btn" class="bg-slate-600 hover:bg-slate-700 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all-300 shadow-sm">
                            <i class="fa fa-compress"></i>
                            <span>压缩</span>
                        </button>
                        <button id="validate-btn" class="bg-info hover:bg-info/90 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all-300 shadow-sm">
                            <i class="fa fa-check-circle"></i>
                            <span>校验</span>
                        </button>
                        <button id="clear-btn" class="bg-slate-400 hover:bg-slate-500 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all-300 shadow-sm">
                            <i class="fa fa-trash"></i>
                            <span>清空</span>
                        </button>
                    </div>
                    <div class="flex flex-wrap gap-2">
                        <select id="indent-select" class="border border-slate-300 rounded-lg px-3 py-2 bg-white focus:ring-2 focus:ring-primary focus:border-primary">
                            <option value="2">缩进: 2空格</option>
                            <option value="4">缩进: 4空格</option>
                            <option value="8">缩进: 8空格</option>
                            <option value="tab">缩进: Tab</option>
                        </select>
                        <button id="copy-btn" class="bg-success hover:bg-success/90 text-white px-4 py-2 rounded-lg flex items-center space-x-2 transition-all-300 shadow-sm">
                            <i class="fa fa-copy"></i>
                            <span>复制</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 编辑器区域 -->
            <div class="p-4">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <!-- 输入区域 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            输入JSON:
                        </label>
                        <div class="relative">
                            <textarea id="json-input" class="json-editor w-full h-96 p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary bg-slate-50 resize-none" placeholder="请输入或粘贴JSON数据..."></textarea>
                            <div id="input-line-numbers" class="absolute top-4 left-2 text-slate-400 font-mono text-sm pointer-events-none"></div>
                        </div>
                    </div>
                    
                    <!-- 输出区域 -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">
                            输出结果:
                            <span id="status-indicator" class="ml-2 text-sm"></span>
                        </label>
                        <div class="relative">
                            <pre id="json-output" class="json-editor w-full h-96 p-4 border border-slate-300 rounded-lg bg-slate-50 overflow-auto"></pre>
                            <div id="output-line-numbers" class="absolute top-4 left-2 text-slate-400 font-mono text-sm pointer-events-none"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 功能卡片 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- JSON转CSV -->
            <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6 hover:shadow-lg transition-all-300">
                <div class="text-primary text-2xl mb-4">
                    <i class="fa fa-file-text-o"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">JSON转CSV</h3>
                <p class="text-slate-600 text-sm mb-4">将JSON数组转换为CSV格式</p>
                <button id="json-to-csv-btn" class="w-full bg-primary/10 hover:bg-primary/20 text-primary px-4 py-2 rounded-lg transition-all-300">
                    转换
                </button>
            </div>

            <!-- CSV转JSON -->
            <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6 hover:shadow-lg transition-all-300">
                <div class="text-info text-2xl mb-4">
                    <i class="fa fa-code"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">CSV转JSON</h3>
                <p class="text-slate-600 text-sm mb-4">将CSV数据转换为JSON格式</p>
                <button id="csv-to-json-btn" class="w-full bg-info/10 hover:bg-info/20 text-info px-4 py-2 rounded-lg transition-all-300">
                    转换
                </button>
            </div>

            <!-- JSON转XML -->
            <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6 hover:shadow-lg transition-all-300">
                <div class="text-warning text-2xl mb-4">
                    <i class="fa fa-exchange"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">JSON转XML</h3>
                <p class="text-slate-600 text-sm mb-4">将JSON数据转换为XML格式</p>
                <button id="json-to-xml-btn" class="w-full bg-warning/10 hover:bg-warning/20 text-warning px-4 py-2 rounded-lg transition-all-300">
                    转换
                </button>
            </div>

            <!-- 生成JSON Schema -->
            <div class="bg-white rounded-xl shadow-md border border-slate-200 p-6 hover:shadow-lg transition-all-300">
                <div class="text-secondary text-2xl mb-4">
                    <i class="fa fa-list-alt"></i>
                </div>
                <h3 class="text-lg font-semibold text-slate-800 mb-2">生成Schema</h3>
                <p class="text-slate-600 text-sm mb-4">根据JSON数据生成JSON Schema</p>
                <button id="generate-schema-btn" class="w-full bg-secondary/10 hover:bg-secondary/20 text-secondary px-4 py-2 rounded-lg transition-all-300">
                    生成
                </button>
            </div>
        </div>

        <!-- 历史记录 -->
        <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
            <div class="bg-slate-50 border-b border-slate-200 p-4">
                <h3 class="text-lg font-semibold text-slate-800">历史记录</h3>
            </div>
            <div class="p-4">
                <div id="history-list" class="space-y-2 max-h-60 overflow-y-auto">
                    <p class="text-slate-500 text-center py-4">暂无历史记录</p>
                </div>
                <div class="flex justify-between mt-4">
                    <button id="clear-history-btn" class="text-sm text-slate-600 hover:text-danger">
                        <i class="fa fa-trash-o"></i> 清空历史
                    </button>
                    <span id="history-count" class="text-sm text-slate-500">0 条记录</span>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white/80 backdrop-blur-sm border-t border-slate-200 py-6 mt-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center text-slate-600 text-sm">
                <p>© 2024 在线工具站 | JSON格式化工具</p>
                <p class="mt-2">提供快速、高效的在线工具服务</p>
            </div>
        </div>
    </footer>

    <!-- 模态框 -->
    <div id="modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-auto">
            <div class="border-b border-slate-200 p-4 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-semibold text-slate-800"></h3>
                <button id="modal-close" class="text-slate-400 hover:text-slate-600">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div id="modal-content" class="p-6">
                <!-- 模态框内容将通过JavaScript动态填充 -->
            </div>
            <div class="border-t border-slate-200 p-4 flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">
                    取消
                </button>
                <button id="modal-confirm" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                    确定
                </button>
            </div>
        </div>
    </div>

    <!-- Toast提示 -->
    <div id="toast" class="fixed top-4 right-4 bg-white rounded-lg shadow-lg border border-slate-200 p-4 transform translate-x-full transition-transform duration-300 z-50 max-w-xs">
        <div class="flex items-center">
            <div id="toast-icon" class="mr-3 text-lg"></div>
            <div class="flex-1">
                <h4 id="toast-title" class="font-medium text-slate-800"></h4>
                <p id="toast-message" class="text-sm text-slate-600"></p>
            </div>
            <button id="toast-close" class="text-slate-400 hover:text-slate-600">
                <i class="fa fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        // 全局变量
        let jsonHistory = JSON.parse(localStorage.getItem('jsonHistory') || '[]');
        let currentTheme = localStorage.getItem('theme') || 'light';

        // DOM元素
        const jsonInput = document.getElementById('json-input');
        const jsonOutput = document.getElementById('json-output');
        const statusIndicator = document.getElementById('status-indicator');
        const indentSelect = document.getElementById('indent-select');
        const inputLineNumbers = document.getElementById('input-line-numbers');
        const outputLineNumbers = document.getElementById('output-line-numbers');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            updateLineNumbers();
            loadHistory();
            setupEventListeners();
            
            // 设置示例JSON
            const exampleJson = {
                "name": "张三",
                "age": 25,
                "email": "zhangsan@example.com",
                "address": {
                    "city": "北京",
                    "district": "朝阳区",
                    "street": "建国路123号"
                },
                "hobbies": ["读书", "旅行", "摄影"],
                "isActive": true,
                "profile": null
            };
            
            jsonInput.value = JSON.stringify(exampleJson, null, 2);
            updateLineNumbers();
        });

        // 设置事件监听器
        function setupEventListeners() {
            // 工具栏按钮
            document.getElementById('format-btn').addEventListener('click', formatJson);
            document.getElementById('compress-btn').addEventListener('click', compressJson);
            document.getElementById('validate-btn').addEventListener('click', validateJson);
            document.getElementById('clear-btn').addEventListener('click', clearJson);
            document.getElementById('copy-btn').addEventListener('click', copyOutput);
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            // 转换功能按钮
            document.getElementById('json-to-csv-btn').addEventListener('click', jsonToCsv);
            document.getElementById('csv-to-json-btn').addEventListener('click', showCsvToJsonModal);
            document.getElementById('json-to-xml-btn').addEventListener('click', jsonToXml);
            document.getElementById('generate-schema-btn').addEventListener('click', generateSchema);

            // 历史记录按钮
            document.getElementById('clear-history-btn').addEventListener('click', clearHistory);

            // 模态框按钮
            document.getElementById('modal-close').addEventListener('click', hideModal);
            document.getElementById('modal-cancel').addEventListener('click', hideModal);
            document.getElementById('modal-confirm').addEventListener('click', handleModalConfirm);

            // Toast关闭按钮
            document.getElementById('toast-close').addEventListener('click', hideToast);

            // 输入框事件
            jsonInput.addEventListener('input', updateLineNumbers);
            jsonInput.addEventListener('scroll', syncScroll);

            // 缩进选择
            indentSelect.addEventListener('change', function() {
                if (jsonOutput.textContent.trim()) {
                    formatJson();
                }
            });
        }

        // JSON格式化
        function formatJson() {
            const input = jsonInput.value.trim();
            if (!input) {
                showToast('警告', '请输入JSON数据', 'warning');
                return;
            }

            try {
                const parsed = JSON.parse(input);
                const indent = indentSelect.value === 'tab' ? '\t' : parseInt(indentSelect.value);
                const formatted = JSON.stringify(parsed, null, indent);
                
                jsonOutput.textContent = formatted;
                applySyntaxHighlight();
                updateLineNumbers();
                updateStatus('success', 'JSON格式化成功');
                addToHistory(input);
                showToast('成功', 'JSON格式化完成', 'success');
            } catch (error) {
                updateStatus('error', `JSON格式错误: ${error.message}`);
                showToast('错误', 'JSON格式无效', 'error');
            }
        }

        // JSON压缩
        function compressJson() {
            const input = jsonInput.value.trim();
            if (!input) {
                showToast('警告', '请输入JSON数据', 'warning');
                return;
            }

            try {
                const parsed = JSON.parse(input);
                const compressed = JSON.stringify(parsed);
                
                jsonOutput.textContent = compressed;
                applySyntaxHighlight();
                updateLineNumbers();
                updateStatus('success', `JSON压缩成功 (${Math.round((1 - compressed.length / input.length) * 100)}% 压缩率)`);
                addToHistory(input);
                showToast('成功', 'JSON压缩完成', 'success');
            } catch (error) {
                updateStatus('error', `JSON格式错误: ${error.message}`);
                showToast('错误', 'JSON格式无效', 'error');
            }
        }

        // JSON校验
        function validateJson() {
            const input = jsonInput.value.trim();
            if (!input) {
                showToast('警告', '请输入JSON数据', 'warning');
                return;
            }

            try {
                const parsed = JSON.parse(input);
                const stats = getJsonStats(parsed);
                
                jsonOutput.textContent = JSON.stringify(parsed, null, 2);
                applySyntaxHighlight();
                updateLineNumbers();
                updateStatus('success', `JSON格式有效 (${stats.keys} 个键, ${stats.values} 个值)`);
                showToast('成功', 'JSON格式有效', 'success');
            } catch (error) {
                updateStatus('error', `JSON格式错误: ${error.message}`);
                showToast('错误', 'JSON格式无效', 'error');
            }
        }

        // 清空JSON
        function clearJson() {
            jsonInput.value = '';
            jsonOutput.textContent = '';
            updateLineNumbers();
            updateStatus('info', '输入框已清空');
            showToast('信息', '内容已清空', 'info');
        }

        // 复制输出
        function copyOutput() {
            const output = jsonOutput.textContent;
            if (!output) {
                showToast('警告', '没有可复制的内容', 'warning');
                return;
            }

            navigator.clipboard.writeText(output).then(() => {
                showToast('成功', '已复制到剪贴板', 'success');
            }).catch(() => {
                showToast('错误', '复制失败', 'error');
            });
        }

        // JSON转CSV
        function jsonToCsv() {
            const input = jsonInput.value.trim();
            if (!input) {
                showToast('警告', '请输入JSON数据', 'warning');
                return;
            }

            try {
                const parsed = JSON.parse(input);
                
                if (!Array.isArray(parsed)) {
                    showToast('警告', '请输入JSON数组格式', 'warning');
                    return;
                }

                if (parsed.length === 0) {
                    showToast('警告', 'JSON数组为空', 'warning');
                    return;
                }

                // 获取所有列名
                const columns = new Set();
                parsed.forEach(item => {
                    if (typeof item === 'object' && item !== null) {
                        Object.keys(item).forEach(key => columns.add(key));
                    }
                });

                const headers = Array.from(columns);
                let csv = headers.join(',') + '\n';

                // 生成CSV内容
                parsed.forEach(item => {
                    const row = headers.map(header => {
                        const value = item[header];
                        if (value === null || value === undefined) return '';
                        if (typeof value === 'object') return `"${JSON.stringify(value).replace(/"/g, '""')}"`;
                        if (typeof value === 'string') return `"${value.replace(/"/g, '""')}"`;
                        return value;
                    });
                    csv += row.join(',') + '\n';
                });

                jsonOutput.textContent = csv;
                updateLineNumbers();
                updateStatus('success', `已转换为CSV格式 (${parsed.length} 行数据)`);
                showToast('成功', 'JSON转CSV完成', 'success');
            } catch (error) {
                updateStatus('error', `转换失败: ${error.message}`);
                showToast('错误', '转换失败', 'error');
            }
        }

        // 显示CSV转JSON模态框
        function showCsvToJsonModal() {
            showModal('CSV转JSON', `
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">输入CSV数据:</label>
                        <textarea id="csv-input" class="w-full h-64 p-4 border border-slate-300 rounded-lg font-mono text-sm" placeholder="请输入或粘贴CSV数据..."></textarea>
                    </div>
                    <div class="flex items-center space-x-2">
                        <input type="checkbox" id="has-headers" checked>
                        <label for="has-headers" class="text-sm text-slate-700">第一行是列名</label>
                    </div>
                </div>
            `, '转换');
        }

        // CSV转JSON
        function csvToJson() {
            const csvInput = document.getElementById('csv-input').value.trim();
            const hasHeaders = document.getElementById('has-headers').checked;

            if (!csvInput) {
                showToast('警告', '请输入CSV数据', 'warning');
                return;
            }

            try {
                const lines = csvInput.split('\n').filter(line => line.trim());
                if (lines.length === 0) {
                    showToast('警告', 'CSV数据为空', 'warning');
                    return;
                }

                const headers = hasHeaders ? parseCsvLine(lines[0]) : lines[0].split(',').map((_, index) => `column${index + 1}`);
                const startIndex = hasHeaders ? 1 : 0;
                
                const jsonArray = [];
                for (let i = startIndex; i < lines.length; i++) {
                    const values = parseCsvLine(lines[i]);
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index] || '';
                    });
                    jsonArray.push(obj);
                }

                const jsonString = JSON.stringify(jsonArray, null, 2);
                jsonInput.value = jsonString;
                jsonOutput.textContent = jsonString;
                applySyntaxHighlight();
                updateLineNumbers();
                updateStatus('success', `已转换为JSON格式 (${jsonArray.length} 条记录)`);
                showToast('成功', 'CSV转JSON完成', 'success');
                hideModal();
            } catch (error) {
                showToast('错误', 'CSV格式无效', 'error');
            }
        }

        // 解析CSV行
        function parseCsvLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                
                if (char === '"') {
                    if (inQuotes && nextChar === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // JSON转XML
        function jsonToXml() {
            const input = jsonInput.value.trim();
            if (!input) {
                showToast('警告', '请输入JSON数据', 'warning');
                return;
            }

            try {
                const parsed = JSON.parse(input);
                const xml = jsonToXmlRecursive(parsed, 'root');
                
                jsonOutput.textContent = xml;
                updateLineNumbers();
                updateStatus('success', '已转换为XML格式');
                showToast('成功', 'JSON转XML完成', 'success');
            } catch (error) {
                updateStatus('error', `转换失败: ${error.message}`);
                showToast('错误', '转换失败', 'error');
            }
        }

        // 递归转换JSON为XML
        function jsonToXmlRecursive(obj, rootName) {
            let xml = `<${rootName}>`;
            
            if (Array.isArray(obj)) {
                obj.forEach((item, index) => {
                    xml += jsonToXmlRecursive(item, `item${index}`);
                });
            } else if (typeof obj === 'object' && obj !== null) {
                Object.keys(obj).forEach(key => {
                    const safeKey = key.replace(/[^a-zA-Z0-9_]/g, '_');
                    xml += jsonToXmlRecursive(obj[key], safeKey);
                });
            } else {
                xml += obj;
            }
            
            xml += `</${rootName}>`;
            return xml;
        }

        // 生成JSON Schema
        function generateSchema() {
            const input = jsonInput.value.trim();
            if (!input) {
                showToast('警告', '请输入JSON数据', 'warning');
                return;
            }

            try {
                const parsed = JSON.parse(input);
                const schema = generateSchemaRecursive(parsed);
                
                schema.$schema = 'http://json-schema.org/draft-07/schema#';
                
                const schemaString = JSON.stringify(schema, null, 2);
                jsonOutput.textContent = schemaString;
                applySyntaxHighlight();
                updateLineNumbers();
                updateStatus('success', '已生成JSON Schema');
                showToast('成功', 'JSON Schema生成完成', 'success');
            } catch (error) {
                updateStatus('error', `生成失败: ${error.message}`);
                showToast('错误', '生成失败', 'error');
            }
        }

        // 递归生成JSON Schema
        function generateSchemaRecursive(obj) {
            if (obj === null) {
                return { type: 'null' };
            }

            if (Array.isArray(obj)) {
                const items = obj.length > 0 ? generateSchemaRecursive(obj[0]) : {};
                return {
                    type: 'array',
                    items: items
                };
            }

            if (typeof obj === 'object') {
                const properties = {};
                Object.keys(obj).forEach(key => {
                    properties[key] = generateSchemaRecursive(obj[key]);
                });
                return {
                    type: 'object',
                    properties: properties,
                    required: Object.keys(obj)
                };
            }

            return { type: typeof obj };
        }

        // 获取JSON统计信息
        function getJsonStats(obj) {
            let keys = 0;
            let values = 0;

            function countRecursive(item) {
                if (Array.isArray(item)) {
                    values += item.length;
                    item.forEach(countRecursive);
                } else if (typeof item === 'object' && item !== null) {
                    keys += Object.keys(item).length;
                    values += Object.keys(item).length;
                    Object.values(item).forEach(countRecursive);
                }
            }

            countRecursive(obj);
            return { keys, values };
        }

        // 语法高亮
        function applySyntaxHighlight() {
            let html = jsonOutput.textContent
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?)/g, function(match) {
                    return match.includes(':') ?
                        '<span class="json-key">' + match.replace(':', '<span class="json-colon">:</span>') + '</span>' :
                        '<span class="json-string">' + match + '</span>';
                })
                .replace(/\b(true|false)\b/g, '<span class="json-boolean">$1</span>')
                .replace(/\b(null)\b/g, '<span class="json-null">$1</span>')
                .replace(/\b(-?(?:0|[1-9]\d*)(?:\.\d+)?(?:[eE][+-]?\d+)?)\b/g, '<span class="json-number">$1</span>');
            
            jsonOutput.innerHTML = html;
        }

        // 更新行号
        function updateLineNumbers() {
            // 输入区域行号
            const inputLines = jsonInput.value.split('\n').length;
            inputLineNumbers.innerHTML = Array.from({ length: inputLines }, (_, i) => i + 1).join('<br>');

            // 输出区域行号
            const outputLines = jsonOutput.textContent.split('\n').length;
            outputLineNumbers.innerHTML = Array.from({ length: outputLines }, (_, i) => i + 1).join('<br>');
        }

        // 同步滚动
        function syncScroll() {
            const scrollPercentage = jsonInput.scrollTop / (jsonInput.scrollHeight - jsonInput.clientHeight);
            jsonOutput.scrollTop = scrollPercentage * (jsonOutput.scrollHeight - jsonOutput.clientHeight);
        }

        // 更新状态指示器
        function updateStatus(type, message) {
            const icons = {
                success: '<i class="fa fa-check-circle text-success"></i>',
                error: '<i class="fa fa-times-circle text-danger"></i>',
                warning: '<i class="fa fa-exclamation-triangle text-warning"></i>',
                info: '<i class="fa fa-info-circle text-info"></i>'
            };
            
            statusIndicator.innerHTML = `${icons[type] || icons.info} ${message}`;
        }

        // 添加到历史记录
        function addToHistory(json) {
            // 检查是否已存在相同的JSON
            const existingIndex = jsonHistory.findIndex(item => item.json === json);
            if (existingIndex !== -1) {
                // 如果存在，移到最前面并更新时间
                jsonHistory.splice(existingIndex, 1);
            }

            jsonHistory.unshift({
                json: json,
                timestamp: new Date().toISOString(),
                preview: json.length > 100 ? json.substring(0, 100) + '...' : json
            });

            // 限制历史记录数量
            if (jsonHistory.length > 20) {
                jsonHistory = jsonHistory.slice(0, 20);
            }

            localStorage.setItem('jsonHistory', JSON.stringify(jsonHistory));
            loadHistory();
        }

        // 加载历史记录
        function loadHistory() {
            const historyList = document.getElementById('history-list');
            const historyCount = document.getElementById('history-count');

            if (jsonHistory.length === 0) {
                historyList.innerHTML = '<p class="text-slate-500 text-center py-4">暂无历史记录</p>';
                historyCount.textContent = '0 条记录';
                return;
            }

            historyList.innerHTML = jsonHistory.map((item, index) => `
                <div class="bg-slate-50 rounded-lg p-3 hover:bg-slate-100 cursor-pointer transition-all-300">
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs text-slate-500">${new Date(item.timestamp).toLocaleString()}</span>
                        <button onclick="deleteHistoryItem(${index})" class="text-slate-400 hover:text-danger text-sm">
                            <i class="fa fa-trash-o"></i>
                        </button>
                    </div>
                    <pre class="text-xs font-mono text-slate-700 whitespace-pre-wrap break-all" onclick="loadHistoryItem(${index})">${item.preview}</pre>
                </div>
            `).join('');

            historyCount.textContent = `${jsonHistory.length} 条记录`;
        }

        // 加载历史记录项
        function loadHistoryItem(index) {
            if (jsonHistory[index]) {
                jsonInput.value = jsonHistory[index].json;
                updateLineNumbers();
                showToast('成功', '已加载历史记录', 'success');
            }
        }

        // 删除历史记录项
        function deleteHistoryItem(index) {
            jsonHistory.splice(index, 1);
            localStorage.setItem('jsonHistory', JSON.stringify(jsonHistory));
            loadHistory();
            showToast('成功', '已删除历史记录', 'success');
        }

        // 清空历史记录
        function clearHistory() {
            if (jsonHistory.length === 0) {
                showToast('警告', '历史记录为空', 'warning');
                return;
            }

            showModal('确认清空', '确定要清空所有历史记录吗？此操作不可撤销。', '清空', 'warning');
        }

        // 处理模态框确认
        function handleModalConfirm() {
            const title = document.getElementById('modal-title').textContent;
            
            if (title === '确认清空') {
                jsonHistory = [];
                localStorage.removeItem('jsonHistory');
                loadHistory();
                showToast('成功', '历史记录已清空', 'success');
                hideModal();
            } else if (title === 'CSV转JSON') {
                csvToJson();
            }
        }

        // 显示模态框
        function showModal(title, content, confirmText = '确定', type = 'info') {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').innerHTML = content;
            document.getElementById('modal-confirm').textContent = confirmText;
            document.getElementById('modal').classList.remove('hidden');
            
            // 设置确认按钮样式
            const confirmBtn = document.getElementById('modal-confirm');
            confirmBtn.className = 'px-4 py-2 rounded-lg hover:opacity-90 transition-all-300';
            
            switch (type) {
                case 'success':
                    confirmBtn.className += ' bg-success text-white';
                    break;
                case 'error':
                    confirmBtn.className += ' bg-danger text-white';
                    break;
                case 'warning':
                    confirmBtn.className += ' bg-warning text-white';
                    break;
                default:
                    confirmBtn.className += ' bg-primary text-white';
            }
        }

        // 隐藏模态框
        function hideModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // 显示Toast
        function showToast(title, message, type = 'info') {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');

            toastTitle.textContent = title;
            toastMessage.textContent = message;

            const icons = {
                success: '<i class="fa fa-check-circle text-success"></i>',
                error: '<i class="fa fa-times-circle text-danger"></i>',
                warning: '<i class="fa fa-exclamation-triangle text-warning"></i>',
                info: '<i class="fa fa-info-circle text-info"></i>'
            };

            toastIcon.innerHTML = icons[type] || icons.info;
            toast.classList.remove('translate-x-full');

            // 自动隐藏
            clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(hideToast, 3000);
        }

        // 隐藏Toast
        function hideToast() {
            const toast = document.getElementById('toast');
            toast.classList.add('translate-x-full');
        }

        // 初始化主题
        function initializeTheme() {
            if (currentTheme === 'dark') {
                document.documentElement.classList.add('dark');
                document.getElementById('theme-toggle').innerHTML = '<i class="fa fa-sun-o text-slate-300"></i>';
            }
        }

        // 切换主题
        function toggleTheme() {
            const html = document.documentElement;
            const icon = document.getElementById('theme-toggle').querySelector('i');
            
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                icon.className = 'fa fa-moon-o text-slate-600';
                currentTheme = 'light';
            } else {
                html.classList.add('dark');
                icon.className = 'fa fa-sun-o text-slate-300';
                currentTheme = 'dark';
            }
            
            localStorage.setItem('theme', currentTheme);
        }

        // 点击模态框外部关闭
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideModal();
            }
        });

        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + Enter: 格式化
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                formatJson();
            }
            
            // Ctrl/Cmd + Shift + C: 复制
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                copyOutput();
            }
            
            // Esc: 关闭模态框或Toast
            if (e.key === 'Escape') {
                if (!document.getElementById('modal').classList.contains('hidden')) {
                    hideModal();
                } else {
                    hideToast();
                }
            }
        });
    </script>
</body>
</html>
